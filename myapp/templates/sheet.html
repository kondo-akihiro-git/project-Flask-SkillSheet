{% extends "base.html" %}

{% block content %}
<h1>スキルシート</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
    <ul class="flashes">
        {% set category, message = messages[messages|length-1] %}
        <li class="{{ category }}">{{ message }}</li>
    </ul>
{% endif %}
{% endwith %}

<h1>Profile</h1>

<div class="profile">
    <p>名前: {{ user.display_name }}</p>
    <p>年齢: {{ user.age }}</p>
    <p>性別: {{ user.gender }}</p>
    <p>最寄駅: {{ user.nearest_station }}</p>
    <p>経験年数: {{ user.experience_years }}</p>
    <p>学歴: {{ user.education }}</p>
    <a href="{{ url_for('edit_profile') }}" class="btn btn-primary">プロフィールを編集</a>
</div>

<hr>

<h1>Projects</h1>
{% for item in projects %}
<div class="project">
    <h2>{{ item.project.project_name }}</h2>
    <p>業界: {{ item.project.industry }}</p>
    <p>プロジェクト期間: {{ item.project.start_month }} から {{ item.project.end_month }}</p>
    <p>プロジェクト概要: {{ item.project.project_summary }}</p>
    <p>担当業務: {{ item.project.responsibilities }}</p>

    <h3>使用技術</h3>
    <ul>
        {% for tech in item.technologies %}
        <li>{{ tech.type }}: {{ tech.name }} ({{ tech.duration_months }} ヶ月)</li>
        {% endfor %}
    </ul>

    <h3>担当工程</h3>
    <ul>
        {% for process in item.processes %}
        <li>{{ process.name }}</li>
        {% endfor %}
    </ul>
    <a href="{{ url_for('edit_project', project_id=item.project.id) }}" class="btn btn-primary">プロジェクトを編集</a>
</div>
<hr>

{% endfor %}

<form id="create-link-form" action="{{ url_for('create_link') }}" method="post">
    <button type="submit" class="btn btn-secondary">リンクを作成</button>
</form>

<form id="invalidate-link-form" action="{{ url_for('invalidate_link') }}" method="post">
    <button type="submit" class="btn btn-danger">リンクを無効にする</button>
</form>

<input type="text" id="link-field" readonly style="display: none;">

<script>
    document.getElementById('create-link-form').addEventListener('submit', function(event) {
        event.preventDefault();  // フォームの通常の送信を防ぐ

        fetch('{{ url_for("create_link") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'  // 認証情報を送信
        })
        .then(response => response.json())
        .then(data => {
            if (data.link) {
                // リンクフィールドにリンクを設定
                var linkField = document.getElementById('link-field');
                linkField.value = data.link;
                linkField.style.display = 'block';

                // リンクをクリップボードにコピー
                linkField.select();
                document.execCommand('copy');

                alert('リンクがクリップボードにコピーされました: ' + data.link);
            }
        })
        .catch(error => console.error('Error:', error));
    });

    // リンク無効化時の処理
    document.getElementById('invalidate-link-form').addEventListener('submit', function(event) {
        if (!confirm('本当にリンクを無効にしますか？')) {
            event.preventDefault();  // ユーザーがキャンセルした場合、フォームの送信を防ぐ
        }
    });

</script>

{% endblock %}