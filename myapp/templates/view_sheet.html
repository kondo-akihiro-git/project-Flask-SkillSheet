{% extends "base.html" %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title">スキルシート</h1>

        <div class="box">
            <h1 class="title is-4">プロフィール</h1>
            <div class="columns is-multiline">
                <div class="column is-one-third">
                    <p class="profile-item hg"><strong>名前:</strong> {{ user.display_name or "記載なし" }}</p>
                </div>
                <div class="column is-one-third">
                    <p class="profile-item hg"><strong>年齢:</strong> {{ user.age or "記載なし" }}</p>
                </div>
                <div class="column is-one-third">
                    <p class="profile-item hg"><strong>性別:</strong> {{ user.gender or "記載なし" }}</p>
                </div>
                <div class="column is-one-third">
                    <p class="profile-item hg"><strong>最寄駅:</strong> {{ user.nearest_station or "記載なし" }}</p>
                </div>
                <div class="column is-one-third">
                    <p class="profile-item hg"><strong>経験年数:</strong>
                        {% if user.experience_years %}
                        {{ user.experience_years // 12 }} 年 {{ user.experience_years % 12 }} ヶ月
                        {% else %}
                        記載なし
                        {% endif %}</p>
                </div>
                <div class="column is-one-third">
                    <p class="profile-item hg"><strong>学歴:</strong> {{ user.education or "記載なし" }}</p>
                </div>
            </div>
        </div>

        <hr>

        {% if skills_by_category|length > 0 %}
        <div class="box">
            <h1 class="title is-4">スキル歴</h1>
            <div class="columns is-multiline">
                {% for category, skills in skills_by_category.items() %}
                <div class="column is-one-third">
                    <div class="table-container">
                        <table class="hg table is-bordered is-fullwidth skill-table">
                            <thead>
                                <tr>
                                    <th>{{ category }}</th>
                                    <th>期間</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for skill in skills %}
                                <tr>
                                    <td class="tech-name clickable" data-tech-name="{{ skill.name }}">{{ skill.name }}</td>
                                    <td>
                                        {% if skill.duration_months >= 12 %}
                                        {{ skill.duration_months // 12 }} 年 {{ skill.duration_months % 12 }} ヶ月
                                        {% else %}
                                        {{ skill.duration_months }} ヶ月
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <hr>

        {% if projects|length > 0 %}
        <div id="projects-container">
            {% for item in projects %}
            <div class="card project-card">
                <div class="card-content">
                    <h2 class="subtitle project-title hg" data-index="{{ loop.index }}" style="font-size: 1.5rem;">
                        {{ loop.index }}. {{ item.project.project_name }}
                    </h2>
                    <div class="project-details" style="display: none;">
                        <p class="hg"><strong>業界</strong><span class="industry-item"> {{ item.project.industry }}</span>
                        </p>
                        <p class="hg"><strong>期間</strong><span class="industry-item"> {{ item.project.start_month }}〜{{
                                item.project.end_month }}</span></p>
                        <div class="spacer"></div>
                        <!-- プロジェクト概要をボックスで囲む -->
                        <div class="box is-light hg">
                            <p><strong>プロジェクト概要</strong><br><span class="preformatted">{{ item.project.project_summary
                                    }}</span></p>
                        </div>
                        <!-- 担当工程の視覚化 -->
                        <div class="process-section hg">
                            <strong class="process-title">担当工程</strong>
                            <div class="process-container">
                                {% for process in item.processes %}
                                <span class="tag">{{ process.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="spacer"></div>
                        <!-- 担当業務をボックスで囲む -->
                        <div class="box is-light hg">
                            <p><strong>担当業務</strong><br><span class="preformatted">{{ item.project.responsibilities
                                    }}</span></p>
                        </div>
                        <div class="content mb-3">
                            <h3 class="title is-5">使用技術</h3>
                            <table class="table is-striped is-fullwidth hg">
                                <thead>
                                    <tr>
                                        <th>技術タイプ</th>
                                        <th>技術名</th>
                                        <th>使用期間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tech in item.technologies %}
                                    <tr>
                                        <td>
                                            {% if tech.type == 'os' %}
                                            OS
                                            {% elif tech.type == 'language' %}
                                            言語
                                            {% elif tech.type == 'framework' %}
                                            フレームワーク
                                            {% elif tech.type == 'database' %}
                                            データベース
                                            {% elif tech.type == 'containertech' %}
                                            コンテナ技術
                                            {% elif tech.type == 'cicd' %}
                                            CI/CD
                                            {% elif tech.type == 'logging' %}
                                            ログ
                                            {% elif tech.type == 'tools' %}
                                            その他ツール
                                            {% else %}
                                            未知のタイプ
                                            {% endif %}
                                        </td>
                                        <td>{{ tech.name }}</td>
                                        <td>
                                            {% if tech.duration_months >= 12 %}
                                            {{ tech.duration_months // 12 }} 年 {{ tech.duration_months % 12 }} ヶ月
                                            {% else %}
                                            {{ tech.duration_months }} ヶ月
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <hr>

        {% if individual_developments|length > 0 %}
        <h1 class="title is-4">個人開発一覧</h1>
        <div id="individual-developments-container">
            {% for item in individual_developments %}
            <div class="card individual-development-card">
                <div class="card-content">
                    <h2 class="subtitle development-title hg" data-index="{{ loop.index }}" style="font-size: 1.5rem;">
                        {{ loop.index }}. {{ item.individual_development.development_name }}
                    </h2>
                    <div class="development-details" style="display: none;">
                        <p class="hg"><strong>期間</strong><span class="industry-item"> {{ item.individual_development.start_month
                                }}〜{{ item.individual_development.end_month }}</span></p>
                        <div class="spacer"></div>
                        <!-- 個人開発概要をボックスで囲む -->
                        <div class="box is-light hg">
                            <p><strong>個人開発概要</strong><br><span class="preformatted">{{
                                    item.individual_development.development_summary }}</span></p>
                        </div>
                        <!-- 担当工程の視覚化 -->
                        {% if item.processes|length > 0 %}
                        <div class="process-section hg">
                            <strong class="process-title">担当工程</strong>
                            <div class="process-container">
                                {% for process in item.processes %}
                                <span class="tag">{{ process.name }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="spacer"></div>
                        <!-- 使用技術のテーブル -->
                        {% if item.technologies|length > 0 %}
                        <div class="content mb-3">
                            <h3 class="title is-5">使用技術</h3>
                            <table class="table is-striped is-fullwidth hg">
                                <thead>
                                    <tr>
                                        <th>技術タイプ</th>
                                        <th>技術名</th>
                                        <th>使用期間</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tech in item.technologies %}
                                    <tr>
                                        <td>
                                            {% if tech.type == 'os' %}
                                            OS
                                            {% elif tech.type == 'language' %}
                                            言語
                                            {% elif tech.type == 'framework' %}
                                            フレームワーク
                                            {% elif tech.type == 'database' %}
                                            データベース
                                            {% elif tech.type == 'containertech' %}
                                            コンテナ技術
                                            {% elif tech.type == 'cicd' %}
                                            CI/CD
                                            {% elif tech.type == 'logging' %}
                                            ログ
                                            {% elif tech.type == 'tools' %}
                                            その他ツール
                                            {% else %}
                                            未知のタイプ
                                            {% endif %}
                                        </td>
                                        <td>{{ tech.name }}</td>
                                        <td>
                                            {% if tech.duration_months >= 12 %}
                                            {{ tech.duration_months // 12 }} 年 {{ tech.duration_months % 12 }} ヶ月
                                            {% else %}
                                            {{ tech.duration_months }} ヶ月
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}



        <div class="hero-button-container">
            <a href="{{ url_for('download_pdf', link_code=link_code) }}" class="button is-primary"
                style="margin-top: 2rem;">PDFダウンロード</a>
        </div>
    </div>
</section>

<script>
    document.querySelectorAll('.project-title').forEach(title => {
        title.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            const details = document.querySelector(`.project-card:nth-of-type(${index}) .project-details`);

            // Toggle visibility
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        });
    });

    document.querySelectorAll('.development-title').forEach(title => {
        title.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            const details = document.querySelector(`.individual-development-card:nth-of-type(${index}) .development-details`);

            // Toggle visibility
            if (details.style.display === 'none') {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        });
    });


    document.addEventListener('DOMContentLoaded', function () {


        const clickableElements = document.querySelectorAll('.hg');

        clickableElements.forEach(el => {
        el.addEventListener('click', function (event) {
            // すでにハイライトされている場合は、ハイライトを解除
            if (el.classList.contains('highlighted')) {
                el.classList.remove('highlighted');
            } else {
                // 他のすべてのハイライトを解除
                document.querySelectorAll('.highlighted').forEach(highlightedEl => {
                    highlightedEl.classList.remove('highlighted');
                });
                // 新たにクリックされた要素をハイライト
                el.classList.add('highlighted');
            }

            // クリックイベントのバブルを防止
            event.stopPropagation();
        });
    });

    // ページ全体をクリックしたときの処理
    document.addEventListener('click', function (event) {
        // `clickableElements` 以外がクリックされた場合、すべてのハイライトを解除
        if (![...clickableElements].includes(event.target)) {
            document.querySelectorAll('.highlighted').forEach(highlightedEl => {
                highlightedEl.classList.remove('highlighted');
            });
        }
    });



        const techElements = document.querySelectorAll('.tech-name');

        techElements.forEach(el => {
            el.addEventListener('click', function (event) {
                // 既存のポップアップを削除
                const existingTooltip = document.querySelector('.tooltip');
                if (existingTooltip) {
                    existingTooltip.remove();
                }

                const techName = this.getAttribute('data-tech-name');
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = '読み込み中...';  // 最初は「読み込み中...」と表示

                document.body.appendChild(tooltip);

                // ポップアップの位置を設定
                const rect = this.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.bottom + window.scrollY}px`;
                tooltip.classList.add('show');

                // ポップアップの非表示処理
                function hideTooltip(e) {
                    if (!tooltip.contains(e.target) && !e.target.classList.contains('tech-name')) {
                        tooltip.classList.remove('show');
                        setTimeout(() => tooltip.remove(), 300);
                        document.removeEventListener('click', hideTooltip);
                    }
                }

                document.addEventListener('click', hideTooltip);

                // 技術名に関連するプロジェクト情報を取得
                fetch(`/api/tech_projects/${techName}`)
                    .then(response => response.json())
                    .then(data => {
                        const content = getTooltipContent(data.projects, data.developments);
                        tooltip.innerHTML = content;
                    })
                    .catch(error => {
                        console.error('Error fetching project data:', error);
                        tooltip.textContent = 'データの取得に失敗しました';
                    });

                // クリックイベントのバブルを防止
                event.stopPropagation();
            });
        });

        function getTooltipContent(projects, developments) {
            let content = '';

            if (projects && projects.length > 0) {
                content += '<strong style="color: #fff">[プロジェクト]</strong><ul>';
                projects.forEach(project => {
                    content += `<li>${project.number}. ${project.name}</li>`;
                });
                content += '</ul>';
            }

            if (projects && projects.length > 0 && developments && developments.length > 0) {
                content += '<br>';
            }

            if (developments && developments.length > 0) {
                content += '<strong style="color: #fff">[個人開発]</strong><ul>';
                developments.forEach(development => {
                    content += `<li>${development.number}. ${development.name}</li>`;
                });
                content += '</ul>';
            }

            if (!content) {
                content = 'この技術は使用されていません。';
            }

            return content;
        }
    });

</script>

<style>
    .tooltip {
        position: absolute;
        background: #333;
        color: #fff;
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        white-space: nowrap;
        z-index: 1000;
        max-width: 600px;
        /* 最大幅を広げて内容に合わせる */
        font-size: 0.875rem;
        /* フォントサイズを調整 */
        line-height: 1.5;
        transition: opacity 0.2s ease-in-out;
        opacity: 0;
        visibility: hidden;
    }

    .tooltip.show {
        opacity: 1;
        visibility: visible;
    }

    .tooltip::after {
        content: '';
        /* 矢印を表示しないように設定 */
        position: absolute;
        border-width: 6px;
        border-style: solid;
        border-color: transparent transparent transparent transparent;
        /* 矢印の色を透明に設定 */
        top: -12px;
        left: 15px;
    }

    /* 強調表示のスタイル */
    .highlighted {
        background-color: #ffe082;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.7);
        border-radius: 4px;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    /* 強調表示が適用されるテーブル */
    .highlighted table {
        background-color: #ffe082;
        /* テーブル全体の背景色を変更 */
    }

    /* テーブルのヘッダー（<th>）とデータセル（<td>）のスタイル */
    .highlighted th,
    .highlighted td {
        color: #333;
        /* テーブルのボーダー色を設定 */
        background-color: #ffe082;
        /* セルの背景色を変更 */
    }
</style>

{% endblock %}