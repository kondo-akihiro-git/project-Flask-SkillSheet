{% extends "base.html" %}

{% block content %}
<h1>ユーザー一覧</h1>
<a href="{{ url_for('admin_login') }}">ログイン画面に戻る</a>
<a href="{{ url_for('admin_dashboard') }}">ダッシュボードに戻る</a>
<a href="{{ url_for('admin_user_create') }}">新規ユーザー登録</a>

<form id="searchForm">
    <input type="text" name="user_id" placeholder="ユーザーID" />
    <input type="text" name="username" placeholder="ユーザー名" />
    <input type="text" name="display_name" placeholder="表示名" />
    <input type="text" name="age" placeholder="年齢" />
    <input type="text" name="gender" placeholder="性別" />
    <input type="text" name="nearest_station" placeholder="最寄り駅" />
    <input type="text" name="experience_years" placeholder="経験年数" />
    <input type="text" name="education" placeholder="学歴" />
    <input type="text" name="latest_active_link_url" placeholder="最新スキルシート" />
    <select name="is_admin">
        <option value="">管理者ステータス</option>
        <option value="null">登録なし</option>
        <option value="false">一般ユーザー</option>
        <option value="true">管理者</option>
    </select>
    <button type="submit">検索</button>
</form>

<table>
    <thead>
        <tr>
            <th>ユーザーID</th>
            <th>ユーザー名</th>
            <th>表示名</th>
            <th>年齢</th>
            <th>性別</th>
            <th>最寄り駅</th>
            <th>経験年数</th>
            <th>学歴</th>
            <th>最新スキルシート</th>
            <th>管理者</th>
            <th>アクション</th>
        </tr>
    </thead>
    <tbody id="userTableBody">
        <!-- ユーザーデータがここに表示される -->
    </tbody>
</table>
<div id="pagination">
    <!-- ページネーションがここに表示される -->
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers(1);
        
        document.getElementById('searchForm').addEventListener('submit', function(event) {
            event.preventDefault();
            loadUsers(1);
        });
    });

    function loadUsers(page) {
        const formData = new FormData(document.getElementById('searchForm'));
        const query = new URLSearchParams(formData).toString();

        fetch(`/admin/users_pagination?page=${page}&${query}`)
            .then(response => response.json())
            .then(data => {
                const userTableBody = document.getElementById('userTableBody');
                userTableBody.innerHTML = '';

                data.users.forEach(user => {
                    const row = document.createElement('tr');

                    const adminStatus = user.is_admin === null ? '登録なし' : (user.is_admin ? '管理者' : '一般ユーザー');

                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username || ''}</td>
                        <td>${user.display_name || ''}</td>
                        <td>${user.age || ''}</td>
                        <td>${user.gender || ''}</td>
                        <td>${user.nearest_station || ''}</td>
                        <td>${user.experience_years || ''}</td>
                        <td>${user.education || ''}</td>
                        <td>${user.latest_active_link_url ? `<a href="${user.latest_active_link_url}">${user.latest_active_link_url}</a>` : 'なし'}</td>
                        <td>${adminStatus}</td>
                        <td>
                            <a href="/admin/user/${user.id}">詳細</a>
                            <form action="/admin/user/delete/${user.id}" method="post" style="display:inline;">
                                <button type="submit">削除</button>
                            </form>
                        </td>
                    `;

                    userTableBody.appendChild(row);
                });

                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';

                for (let i = 1; i <= data.pages; i++) {
                    const pageLink = document.createElement('a');
                    pageLink.href = "#";
                    pageLink.innerText = i;
                    pageLink.onclick = function() {
                        loadUsers(i);
                    };
                    pagination.appendChild(pageLink);
                }
            });
    }
</script>
{% endblock %}
